# プラグインのあるべき動作

## 用語定義

### ナビゲーションとは
以下のOData URL形式を「ナビゲーション」とする:
- `/Parents(1)/children` (ナビゲーションプロパティ経由)
- `/Parents?$expand=children` ($expand使用)

以下は「直接アクセス」とする:
- `/Children` (エンティティセットへの直接アクセス)
- `/Children(1)` (キー指定の直接アクセス)
- `/Children?$filter=parent_ID eq 1` (フィルタ条件による直接アクセス)

### キー指定アクセスの判定
- 単一キー: `/Books(1)` のようにキーが指定されている場合
- 複合キー: `/Books(ID=1,version=2)` のようにすべてのキーが指定されている場合
- キー指定なし: `/Books?$filter=ID eq 1` のように一部のキーのみの場合

## 1. 削除時の動作
| ケース | 状態         | 対象                      | 条件 / トリガ                            | 動作                                                                 | 備考                    |
| --- | ---------- | ----------------------- | ----------------------------------- | ------------------------------------------------------------------ | --------------------- |
| 削除時 | アクティブ      | ルートエンティティ               | DELETE (キー指定)                       | アクティブエンティティの `isDeleted=true` を設定し、`deletedAt` / `deletedBy` も更新する | 物理削除は行わない             |
| 削除時 | アクティブ      | ルート配下 Composition Child | 親ルートエンティティの DELETE                  | Composition Child も `isDeleted=true` をカスケード設定する                    | 孫以降もカスケード             |
| 削除時 | アクティブ      | Composition Child       | DELETE (キー指定)                       | 対象の子エンティティの `isDeleted=true` を設定し、配下の子もカスケード設定                     | 親ルートは未変更              |
| 削除時 | ドラフト       | ルートエンティティ               | ドラフト破棄                              | ドラフト行を物理削除する（論理削除はしない）                                             | Composition Childも物理削除される（フレームワーク動作） |
| 削除時 | ドラフト       | Composition Child       | ドラフト編集中に子削除                         | ドラフト子行の `isDeleted=true` を設定し、配下の子にもカスケード。有効化時にアクティブへ反映            | Draft-to-Active 同期が必要 |
| 削除時 | アクティブ/ドラフト | ルート / Composition Child | すでに `isDeleted=true` のレコードへの DELETE | 冪等扱いで成功とする（`deletedAt`/`deletedBy`は更新しない）                              | エラーにはしない              |

## 2. 照会時の動作（共通ルール）
共通ルール（R1〜R4）

- R1：$filter に isDeleted 指定が ない 場合は isDeleted=false のみ返す
- R2：$filter に isDeleted 指定が ある 場合はその条件を優先
- R3：キー指定アクセス (GET /Entity(key)) は isDeleted に関係なく対象行を返す
- R4：親が削除済 (isDeleted=true) のナビゲーションは、削除済の子を返す（参照目的）

## 3. 照会時の動作（アクティブ）
| ケース | 状態    | 対象       | アクセス / 条件                    | 動作                            | 備考 |
| --- | ----- | -------- | ---------------------------- | ----------------------------- | -- |
| 照会時 | アクティブ | ルート      | キー指定なし、`isDeleted` 指定なし      | `isDeleted=false` のレコードのみ返す   | R1 |
| 照会時 | アクティブ | ルート      | `$filter=isDeleted eq true`  | `isDeleted=true` のレコードのみ返す    | R2 |
| 照会時 | アクティブ | ルート      | `$filter=isDeleted eq false` | `isDeleted=false` のレコードを返す    | R2 |
| 照会時 | アクティブ | ルート（未削除） | キー指定あり                       | 該当レコードを返す (`isDeleted=false`) | R3 |
| 照会時 | アクティブ | ルート（削除済） | キー指定あり                       | 該当レコードを返す (`isDeleted=true`)  | R3 |

### 3.2 Composition Child（アクティブ）— 直接アクセス
| ケース | 状態    | 対象     | アクセス / 条件                    | 動作                           | 備考 |
| --- | ----- | ------ | ---------------------------- | ---------------------------- | -- |
| 照会時 | アクティブ | 子      | キー指定なし、`isDeleted` 指定なし      | `isDeleted=false` の子のみ返す     | R1 |
| 照会時 | アクティブ | 子      | `$filter=isDeleted eq true`  | `isDeleted=true` の子のみ返す      | R2 |
| 照会時 | アクティブ | 子      | `$filter=isDeleted eq false` | `isDeleted=false` の子のみ返す     | R2 |
| 照会時 | アクティブ | 子（未削除） | キー指定あり                       | 子レコードを返す (`isDeleted=false`) | R3 |
| 照会時 | アクティブ | 子（削除済） | キー指定あり                       | 子レコードを返す (`isDeleted=true`)  | R3 |

### 3.3 Composition Child（アクティブ）— ナビゲーション
| ケース | 状態    | 対象 | 親の状態 / 条件                                      | 動作                         | 備考      |
| --- | ----- | -- | ---------------------------------------------- | -------------------------- | ------- |
| 照会時 | アクティブ | 子  | 親未削除 / `$expand`、`isDeleted` 指定なし              | `isDeleted=false` の子のみ返す   | R1      |
| 照会時 | アクティブ | 子  | 親未削除 / Navigation、`$filter=isDeleted eq true`  | `isDeleted=true` の子のみ返す    | R2      |
| 照会時 | アクティブ | 子  | 親未削除 / Navigation、`isDeleted` 指定なし or false    | `isDeleted=false` の子のみ返す   | R1      |
| 照会時 | アクティブ | 子  | 親削除済 / `$expand`、`isDeleted` 指定なし              | `isDeleted=true` の子のみ返す    | R4      |
| 照会時 | アクティブ | 子  | 親削除済 / Navigation、`$filter=isDeleted eq true`  | `isDeleted=true` の子のみ返す    | R2 + R4 |
| 照会時 | アクティブ | 子  | 親削除済 / Navigation、`$filter=isDeleted eq false` | ヒットなし | カスケード削除により該当データが存在しないため、フィルタ条件を満たすレコードがなく結果は空 |


## 4. 照会時の動作（ドラフト）
### 4.1 ドラフト ルートエンティティ
| ケース | 状態   | 対象       | アクセス / 条件                   | 動作                          | 備考     |
| --- | ---- | -------- | --------------------------- | --------------------------- | ------ |
| 照会時 | ドラフト | ルート      | キー指定なし、`isDeleted` 指定なし     | `isDeleted=false` のドラフトのみ返す | R1     |
| 照会時 | ドラフト | ルート      | `$filter=isDeleted eq true` | 該当なし（ドラフトルートの論理削除は行わない）     | 仕様上の前提 |
| 照会時 | ドラフト | ルート（未削除） | キー指定あり                      | 該当ドラフトを返す                   | R3     |
| 照会時 | ドラフト | ルート（削除済） | キー指定あり                      | 考慮不要    | ドラフトは物理削除のため、起こりえない |

### 4.2 Composition Child（ドラフト）— 直接アクセス
| ケース | 状態   | 対象     | アクセス / 条件                   | 動作                           | 備考         |
| --- | ---- | ------ | --------------------------- | ---------------------------- | ---------- |
| 照会時 | ドラフト | 子      | キー指定なし、`isDeleted` 指定なし     | `isDeleted=false` の子ドラフトのみ返す | R1         |
| 照会時 | ドラフト | 子      | `$filter=isDeleted eq true` | `isDeleted=true` の子ドラフトのみ返す  | R2         |
| 照会時 | ドラフト | 子（未削除） | キー指定あり                      | 子ドラフトを返す                     | R3         |
| 照会時 | ドラフト | 子（削除済） | キー指定あり                      | 子ドラフトを返す                     | 削除行の参照用途など |

### 4.3 Composition Child（ドラフト）— ナビゲーション
| ケース | 状態   | 対象 | 親ドラフト状態 / 条件                                  | 動作                       | 備考            |
| --- | ---- | -- | --------------------------------------------- | ------------------------ | ------------- |
| 照会時 | ドラフト | 子  | 親未削除 / `$expand`、`isDeleted` 指定なし             | `isDeleted=false` の子のみ返す | R1            |
| 照会時 | ドラフト | 子  | 親未削除 / Navigation、`$filter=isDeleted eq true` | `isDeleted=true` の子のみ返す  | R2            |
| 照会時 | ドラフト | 子  | 親未削除 / Navigation、`isDeleted` 指定なし or false   | `isDeleted=false` の子のみ返す | R1            |
| 照会時 | ドラフト | 子  | 親削除済（想定外）                                     | 考慮不要                     | ドラフトルートは削除しない |

## 5. ドラフト有効化時の動作
| ケース | 対象 | ドラフト状態 | 動作 | 備考 |
| --- | --- | --- | --- | --- |
| 有効化時 | Composition Child | 新規追加後に`isDeleted=true`設定 | 物理削除（アクティブ側に反映しない） | 一度も有効化していない新規子の場合 |
| 有効化時 | Composition Child | 既存子を`isDeleted=true`に変更 | アクティブ側も`isDeleted=true`に更新 | フレームワークの自動反映（プラグインは何もしない） |

## 6. Association（非Composition）への対応
| ケース | 関係 | 動作 | 備考 |
| --- | --- | --- | --- |
| 削除時 | Association | カスケード削除しない | Association先のエンティティは影響を受けない |
| 照会時 | Association | Association先エンティティには独自の`isDeleted`フィルタが適用される | R1-R4が個別に適用 |

## 7. その他の前提条件
- カスケード削除は全階層に適用される（孫以降もすべて）
- Compositionの循環参照は起こりえないため考慮しない
- ドラフト編集中はロックがかかっているため、他ユーザーによる同時編集は考慮しない
- ドラフト使用時はFiori Elementsでの更新を前提とするため、アクティブ側の直接更新は考慮しない
- 親が削除済の場合、カスケード削除により全ての子も削除済となる（`$expand`で深い階層を展開した場合も同様）